{% extends "system/base.html" %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
  <h2 class="mb-4">Upload Your Team Icon</h2>

  <!-- Step 1: Upload Image -->
  <div id="step-upload">
    <p class="lead">Use a transparent PNG or SVG.</p>

    <div class="my-3">
      <svg id="icon-preview" width="300" height="300" viewBox="0 0 300 300"
           class="border rounded" xmlns="http://www.w3.org/2000/svg">
        
      </svg>
    </div>

    <input type="file" name="icon" id="icon-upload" accept=".png,.svg"
           class="form-control mb-3 mx-auto" style="max-width: 300px;" required>
    <button class="btn btn-primary mt-2" id="btn-to-color" disabled>Next</button>
  </div>

  <!-- Step 2: Color Picker -->
  <div id="step-colors" style="display: none;">
    <h4 class="mb-4">Choose Primary & Secondary Colors</h4>
    <div class="d-flex justify-content-center gap-4 flex-wrap">
      <div class="d-flex flex-column align-items-center justify-content-center p-3" style="border: 3px solid black; border-radius: 8px; min-width: 220px; min-height: 330px;">
        <p class="fw-bold mb-2">Primary</p>
        <div id="primary-picker" class="mb-2"></div>
        <input type="text" id="primary-hex" class="form-control text-center" style="border: 2px solid black; max-width: 120px;" placeholder="#000000">
      </div>
      <div class="d-flex flex-column align-items-center justify-content-center p-3" style="border: 3px solid black; border-radius: 8px; min-width: 220px; min-height: 330px;">
        <p class="fw-bold mb-2">Secondary</p>
        <div id="secondary-picker" class="mb-2"></div>
        <input type="text" id="secondary-hex" class="form-control text-center" style="border: 2px solid black; max-width: 120px;" placeholder="#000000">
      </div>
    </div>
    <button class="btn btn-primary mt-4" id="btn-to-name">Next</button>
  </div>

  <!-- Step 3: Team Name and Submit -->
  <div id="step-name" style="display: none;">
    <div class="mx-auto mt-4 p-4 border border-dark rounded" style="max-width: 600px;">
      <h4 class="mb-3">Team Name</h4>
      <form id="upload-form" method="POST" action="{{ url_for('team.upload_team_icon_page') }}" enctype="multipart/form-data">
        <input type="text" class="form-control mb-3" name="name" placeholder="Enter team name" required>
        <input type="hidden" name="primary_color" id="form_primary_color">
        <input type="hidden" name="secondary_color" id="form_secondary_color">
        <input type="hidden" name="final_svg" id="final_svg">
        <input type="file" name="icon" id="icon-hidden" style="display: none;" />
        <button type="submit" class="btn btn-success mt-2 px-4">
          <i class="bi bi-cloud-arrow-up"></i> Save Team Icon
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const uploadInput = document.getElementById("icon-upload");
  const preview = document.getElementById("icon-preview");
  const btnToColor = document.getElementById("btn-to-color");
  const btnToName = document.getElementById("btn-to-name");

  let primaryPicker, secondaryPicker;

  function rgbToHex(r, g, b) {
    return "#" + [r, g, b].map(x => {
      const hex = x.toString(16);
      return hex.length === 1 ? "0" + hex : hex;
    }).join("");
  }

  function extractColorsFromImage(img, callback) {
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 300;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, 300, 300);
    ctx.drawImage(img, 0, 0, 300, 300);

    const data = ctx.getImageData(0, 0, 300, 300).data;
    const colorCount = {};
    for (let i = 0; i < data.length; i += 4) {
      const [r, g, b, a] = [data[i], data[i + 1], data[i + 2], data[i + 3]];
      if (a < 200) continue;
      const key = `${r},${g},${b}`;
      colorCount[key] = (colorCount[key] || 0) + 1;
    }
    const sortedColors = Object.entries(colorCount)
      .sort((a, b) => b[1] - a[1])
      .map(([rgb]) => rgbToHex(...rgb.split(',').map(Number)));
    callback(sortedColors[0] || "#000000", sortedColors[1] || "#ffffff");
  }

  function cropAndCenterImage(img, callback) {
    const tempCanvas = document.createElement("canvas");
    const ctx = tempCanvas.getContext("2d");
    tempCanvas.width = img.width;
    tempCanvas.height = img.height;
    ctx.drawImage(img, 0, 0);
    const imageData = ctx.getImageData(0, 0, img.width, img.height);
    let minX = img.width, minY = img.height, maxX = 0, maxY = 0;
    for (let y = 0; y < img.height; y++) {
      for (let x = 0; x < img.width; x++) {
        const i = (y * img.width + x) * 4;
        if (imageData.data[i + 3] > 10) {
          minX = Math.min(minX, x);
          minY = Math.min(minY, y);
          maxX = Math.max(maxX, x);
          maxY = Math.max(maxY, y);
        }
      }
    }
    const w = maxX - minX + 1;
    const h = maxY - minY + 1;

    // Scale it to max 200x200
    const scale = Math.min(200 / w, 200 / h, 1);
    const newW = Math.round(w * scale);
    const newH = Math.round(h * scale);

    const cropped = document.createElement("canvas");
    cropped.width = newW;
    cropped.height = newH;
    const croppedCtx = cropped.getContext("2d");
    croppedCtx.drawImage(tempCanvas, minX, minY, w, h, 0, 0, newW, newH);

    const resultImg = new Image();
    resultImg.onload = () => callback(resultImg, newW, newH);
    resultImg.src = cropped.toDataURL();
  }

  uploadInput.addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (event) {
      while (preview.lastChild && preview.lastChild.tagName !== "rect") {
        preview.removeChild(preview.lastChild);
      }
      const hiddenInput = document.getElementById("icon-hidden");
      hiddenInput.files = e.target.files;

      if (file.type === "image/svg+xml") {
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(event.target.result, "image/svg+xml");
        const svgEl = svgDoc.querySelector("svg");
        if (!svgEl) return;
        const imported = document.importNode(svgEl, true);
        imported.setAttribute("width", 200);
        imported.setAttribute("height", 200);
        imported.setAttribute("x", 50);
        imported.setAttribute("y", 50);
        preview.appendChild(imported);
        btnToColor.disabled = false;

        const clone = preview.cloneNode(true);
        clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        const serializer = new XMLSerializer();
        const svgString = serializer.serializeToString(clone);
        document.getElementById("final_svg").value = svgString;

      } else if (file.type === "image/png") {
        const img = new Image();
        img.src = event.target.result;
        img.onload = function () {
          cropAndCenterImage(img, (croppedImg, w, h) => {
            const x = (300 - w) / 2;
            const y = (300 - h) / 2;
            const imageEl = document.createElementNS("http://www.w3.org/2000/svg", "image");
            imageEl.setAttribute("href", croppedImg.src);
            imageEl.setAttribute("x", x);
            imageEl.setAttribute("y", y);
            imageEl.setAttribute("width", w);
            imageEl.setAttribute("height", h);
            preview.appendChild(imageEl);

            extractColorsFromImage(croppedImg, (primary, secondary) => {
              primaryPicker.color.hexString = primary;
              secondaryPicker.color.hexString = secondary;
            });

            const clone = preview.cloneNode(true);
            clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            const serializer = new XMLSerializer();
            const svgString = serializer.serializeToString(clone);
            document.getElementById("final_svg").value = svgString;

            btnToColor.disabled = false;
          });
        };
      }
    };
    reader.readAsDataURL(file);
  });

  btnToColor.addEventListener("click", () => {
    document.getElementById("step-upload").style.display = "none";
    document.getElementById("step-colors").style.display = "block";
  });

  btnToName.addEventListener("click", () => {
    document.getElementById("step-colors").style.display = "none";
    document.getElementById("step-name").style.display = "block";
    document.getElementById("form_primary_color").value = primaryPicker.color.hexString;
    document.getElementById("form_secondary_color").value = secondaryPicker.color.hexString;
  });

  window.onload = function () {
    primaryPicker = new iro.ColorPicker("#primary-picker", {
      width: 120,
      color: "#ff0000"
    });
    secondaryPicker = new iro.ColorPicker("#secondary-picker", {
      width: 120,
      color: "#0000ff"
    });
    const primaryHexInput = document.getElementById("primary-hex");
    const secondaryHexInput = document.getElementById("secondary-hex");

    primaryPicker.on("color:change", color => {
      primaryHexInput.value = color.hexString;
    });
    secondaryPicker.on("color:change", color => {
      secondaryHexInput.value = color.hexString;
    });

    primaryHexInput.addEventListener("change", function () {
      if (/^#([0-9A-F]{3}){1,2}$/i.test(this.value)) {
        primaryPicker.color.hexString = this.value;
      }
    });
    secondaryHexInput.addEventListener("change", function () {
      if (/^#([0-9A-F]{3}){1,2}$/i.test(this.value)) {
        secondaryPicker.color.hexString = this.value;
      }
    });
  };
</script>

{% endblock %}
