{% extends "system/base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>

<div class="container mt-5">
    <h2 class="text-center mb-4">Create Your Team Shield</h2>
    <div class="row justify-content-center">
        <div class="col-lg-6 text-center d-flex flex-column align-items-center">
            <div class="step-container w-100 mb-3" style="min-height: 500px;">
                <!-- Step 1: Shape -->
                <div id="step-shape" class="w-100">
                    <h5>Select a Shield Shape</h5>
                    <div class="row g-3 mb-4 mt-3">
                        {% for shape in base_files %}
                        <div class="col-4 d-flex justify-content-center">
                            <img src="/static/team_creation_assets/base/{{ shape }}"
                                 data-shape="{{ shape }}"
                                 class="shape-thumb"
                                 style="width: 100px; height: auto; border: 3px solid transparent; border-radius: 8px; cursor: pointer;" />
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Step 2: Pattern -->
                <div id="step-pattern" class="w-100" style="display: none;">
                    <h5>Select a Pattern</h5>
                    <div class="row g-3 mt-2">
                        {% for num in range(1, 7) %}
                        <div class="col-4 d-flex justify-content-center">
                            <div class="pattern-thumb" data-pattern="pattern{{ num }}"
                                 style="width: 60px; height: 60px; border: 2px solid transparent; cursor: pointer;">
                                <svg id="thumb-pattern{{ num }}" width="60" height="60"></svg>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Step 3: Color -->
                <div id="step-color" class="w-100" style="display: none;">
                    <h5>Select Colors</h5>
                    <div class="d-flex justify-content-center mt-3 gap-5">
                        <div class="text-center">
                            <p>Primary Color</p>
                            <div id="primary-picker"></div>
                        </div>
                        <div class="text-center">
                            <p>Secondary Color</p>
                            <div id="secondary-picker"></div>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <p><strong>Move Pattern</strong></p>
                        <div><button class="btn btn-sm btn-outline-dark" onclick="movePattern(0, -10)">↑</button></div>
                        <div>
                            <button class="btn btn-sm btn-outline-dark" onclick="movePattern(-10, 0)">←</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="movePattern(10, 0)">→</button>
                        </div>
                        <div><button class="btn btn-sm btn-outline-dark" onclick="movePattern(0, 10)">↓</button></div>
                    </div>
                </div>

                <!-- Step 4: Icon -->
                <div id="step-icon" class="w-100" style="display: none;">
                    <h5>Choose or Upload an Icon</h5>
                    <div class="row g-3 mt-3 justify-content-center" id="icon-container"></div>
                    <input type="file" name="icon-upload" id="icon-upload" accept=".png,.svg" class="form-control mt-3" />

                    <div class="mt-3">
                        <button class="btn btn-secondary me-2" id="icon-prev" disabled>Previous</button>
                        <button class="btn btn-secondary" id="icon-next">Next</button>
                    </div>

                    <div class="text-center mt-3">
                        <p><strong>Move Icon</strong></p>
                        <div><button class="btn btn-sm btn-outline-dark" onclick="moveIcon(0, -10)">↑</button></div>
                        <div>
                            <button class="btn btn-sm btn-outline-dark" onclick="moveIcon(-10, 0)">←</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="moveIcon(10, 0)">→</button>
                        </div>
                        <div><button class="btn btn-sm btn-outline-dark" onclick="moveIcon(0, 10)">↓</button></div>
                    </div>
                </div>

                <!-- Final Save Form -->
                <form id="save-form" method="POST" action="/team/create" enctype="multipart/form-data" class="mt-4" style="display: none;">
                    <div class="mb-3">
                        <input type="text" class="form-control" name="name" id="team-name" placeholder="Enter Team Name" required>
                    </div>
                    <input type="hidden" name="primary_color" id="form_primary_color">
                    <input type="hidden" name="secondary_color" id="form_secondary_color">
                    <input type="hidden" name="icon_filename" id="form_icon_filename">
                    <input type="file" name="icon-upload" id="form_icon_upload" style="display: none;" />
                    <input type="hidden" name="final_svg" id="final_svg">
                    <button type="submit" class="btn btn-success">Save Team</button>
                </form>
            </div>

            <div class="d-flex justify-content-center mt-2" style="min-height: 60px;">
                <button class="btn btn-secondary me-2" id="btn-back" style="display: none;">Back</button>
                <button class="btn btn-primary" id="btn-next" disabled>Next</button>
            </div>
        </div>

        <!-- Live Preview -->
        <div class="col-lg-6 text-center">
            <h5 class="mb-3">Live Preview</h5>
            <svg id="live-preview" width="300" height="300" xmlns="http://www.w3.org/2000/svg"
                 class="border rounded" style="background-color: white;">
                <defs>
                    {% for num in range(1, 7) %}
                    <pattern id="pattern{{ num }}" patternUnits="userSpaceOnUse" width="60" height="60"></pattern>
                    {% endfor %}
                    <clipPath id="shield-clip"><path id="clip-path-shape" d="" /></clipPath>
                </defs>
                <g id="shield-group">
                    <g clip-path="url(#shield-clip)">
                        <rect id="pattern-fill" width="100%" height="100%" fill="none" />
                        <image id="shield-icon" href="" width="60" height="60" x="120" y="120" visibility="hidden"/>
                    </g>
                    <path id="shield-outline" d="" fill="none" stroke="#333" stroke-width="1.5"/>
                </g>
            </svg>
        </div>
    </div>
</div>
<script>
const steps = ["step-shape", "step-pattern", "step-color", "step-icon"];
let currentStep = 0;

const btnNext = document.getElementById("btn-next");
const btnBack = document.getElementById("btn-back");

const shapeThumbs = document.querySelectorAll(".shape-thumb");
const patternThumbs = document.querySelectorAll(".pattern-thumb");
const clipPathShape = document.getElementById("clip-path-shape");
const shieldOutline = document.getElementById("shield-outline");
const patternFill = document.getElementById("pattern-fill");
const livePreview = document.getElementById("live-preview");
const shieldIcon = document.getElementById("shield-icon");

let selectedShape = null;
let selectedPattern = null;
let selectedIcon = null;
let primaryColor = "#d32f2f";
let secondaryColor = "#fdd835";

const primaryPicker = new iro.ColorPicker("#primary-picker", { width: 150, color: primaryColor });
const secondaryPicker = new iro.ColorPicker("#secondary-picker", { width: 150, color: secondaryColor });

primaryPicker.on(["color:change", "input:change"], color => {
    primaryColor = color.hexString;
    updatePatternColors();
    updateIconContrastColor();
});

secondaryPicker.on(["color:change", "input:change"], color => {
    secondaryColor = color.hexString;
    updatePatternColors();
    updateIconContrastColor();
});

shapeThumbs.forEach(thumb => {
    thumb.addEventListener("click", () => {
        shapeThumbs.forEach(t => t.style.border = "3px solid transparent");
        thumb.style.border = "3px solid #007bff";
        selectedShape = thumb.dataset.shape;
        fetchShapePath(selectedShape);
        btnNext.disabled = false;
    });
});

patternThumbs.forEach(thumb => {
    thumb.addEventListener("click", () => {
        patternThumbs.forEach(t => t.style.border = "2px solid transparent");
        thumb.style.border = "2px solid #007bff";
        selectedPattern = thumb.dataset.pattern;
        patternFill.setAttribute("fill", `url(#${selectedPattern})`);
        updatePatternColors();
        btnNext.disabled = false;
    });
});

btnNext.addEventListener("click", () => {
    document.getElementById(steps[currentStep]).style.display = "none";
    currentStep++;

    if (currentStep < steps.length) {
        document.getElementById(steps[currentStep]).style.display = "block";
        btnBack.style.display = "inline-block";
        btnNext.disabled = (steps[currentStep] === "step-pattern" && !selectedPattern);
    }

    if (currentStep === steps.length - 1) loadIcons();
    if (currentStep === steps.length) btnNext.style.display = "none";
});

btnBack.addEventListener("click", () => {
    document.getElementById(steps[currentStep]).style.display = "none";
    currentStep--;
    document.getElementById(steps[currentStep]).style.display = "block";
    btnNext.style.display = "inline-block";
    btnBack.style.display = currentStep === 0 ? "none" : "inline-block";
    btnNext.disabled = (steps[currentStep] === "step-shape" && !selectedShape) ||
                       (steps[currentStep] === "step-pattern" && !selectedPattern);
});

function fetchShapePath(filename) {
    fetch(`/static/team_creation_assets/base/${filename}`)
        .then(res => res.text())
        .then(svgText => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(svgText, "image/svg+xml");
            const path = doc.querySelector("path");
            if (!path) return;
            const d = path.getAttribute("d");
            const tempSVG = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            const tempPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
            tempPath.setAttribute("d", d);
            tempSVG.appendChild(tempPath);
            document.body.appendChild(tempSVG);
            const bbox = tempPath.getBBox();
            document.body.removeChild(tempSVG);

            livePreview.setAttribute("viewBox", `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
            clipPathShape.setAttribute("d", d);
            shieldOutline.setAttribute("d", d);
            if (selectedPattern) patternFill.setAttribute("fill", `url(#${selectedPattern})`);
        });
}

function updatePatternColors() {
    for (let i = 1; i <= 6; i++) {
        const pattern = document.getElementById(`pattern${i}`);
        const thumbPattern = document.getElementById(`thumb-pattern${i}`);
        if (!pattern || !thumbPattern) continue;

        let svgContent = "";
        switch (i) {
            case 1: svgContent = `<rect width="30" height="60" fill="${primaryColor}"/><rect x="30" width="30" height="60" fill="${secondaryColor}"/>`; break;
            case 2: svgContent = `<rect width="60" height="60" fill="${secondaryColor}"/><line x1="0" y1="0" x2="60" y2="60" stroke="${primaryColor}" stroke-width="10"/><line x1="0" y1="60" x2="60" y2="0" stroke="${primaryColor}" stroke-width="10"/>`; break;
            case 3: svgContent = `<rect width="60" height="60" fill="${secondaryColor}"/><line x1="0" y1="0" x2="60" y2="60" stroke="${primaryColor}" stroke-width="10"/><line x1="-30" y1="0" x2="30" y2="60" stroke="${primaryColor}" stroke-width="10"/><line x1="30" y1="0" x2="90" y2="60" stroke="${primaryColor}" stroke-width="10"/>`; break;
            case 4: svgContent = `<rect width="60" height="60" fill="${primaryColor}"/><rect y="20" width="60" height="20" fill="${secondaryColor}"/>`; break;
            case 5: svgContent = `<rect width="60" height="60" fill="${secondaryColor}"/><circle cx="30" cy="30" r="20" fill="${primaryColor}"/>`; break;
            case 6: svgContent = `<rect width="60" height="60" fill="${secondaryColor}"/><rect x="0" y="0" width="30" height="30" fill="${primaryColor}"/><rect x="30" y="30" width="30" height="30" fill="${primaryColor}"/>`; break;
        }

        pattern.innerHTML = svgContent;
        thumbPattern.innerHTML = svgContent;
    }

    if (selectedPattern) patternFill.setAttribute("fill", `url(#${selectedPattern})`);
}

function hexToLuminance(hex) {
    const rgb = hex.replace("#", "").match(/.{2}/g).map(h => parseInt(h, 16) / 255);
    const [r, g, b] = rgb.map(c => c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4));
    return 0.2126 * r + 0.7152 * g + 0.0722 * b;
}

function updateIconContrastColor() {
    const avgLuminance = (hexToLuminance(primaryColor) + hexToLuminance(secondaryColor)) / 2;
    const iconColor = avgLuminance < 0.5 ? "#ffffff" : "#000000";
    shieldIcon.setAttribute("style", `filter: invert(${iconColor === "#ffffff" ? 1 : 0});`);
}

const iconContainer = document.getElementById("icon-container");
const iconPrev = document.getElementById("icon-prev");
const iconNext = document.getElementById("icon-next");

let iconList = {{ icon_filenames|tojson }};
let currentIconPage = 0;
const iconsPerPage = 8;

function loadIcons() {
    iconContainer.innerHTML = "";
    const start = currentIconPage * iconsPerPage;
    const pageIcons = iconList.slice(start, start + iconsPerPage);

    pageIcons.forEach(filename => {
        const col = document.createElement("div");
        col.className = "col-3";
        col.innerHTML = `
            <img src="/static/team_creation_assets/icons/${filename}"
                 data-icon="${filename}"
                 class="img-thumbnail icon-thumb"
                 style="cursor: pointer; max-height: 70px;" />
        `;
        col.querySelector("img").addEventListener("click", () => {
            document.querySelectorAll(".icon-thumb").forEach(img => img.classList.remove("border-primary"));
            col.querySelector("img").classList.add("border-primary");
            selectedIcon = filename;

            const vb = livePreview.viewBox.baseVal;
            const iconWidth = 400;
            const iconHeight = 400;
            const centerX = vb.x + vb.width / 2 - iconWidth / 2;
            const centerY = vb.y + vb.height / 2 - iconHeight / 2;

            shieldIcon.setAttribute("href", `/static/team_creation_assets/icons/${filename}`);
            shieldIcon.setAttribute("visibility", "visible");
            shieldIcon.setAttribute("width", iconWidth);
            shieldIcon.setAttribute("height", iconHeight);
            shieldIcon.setAttribute("x", centerX);
            shieldIcon.setAttribute("y", centerY);
            updateIconContrastColor();

            document.getElementById("form_icon_filename").value = selectedIcon;
            document.getElementById("form_primary_color").value = primaryColor;
            document.getElementById("form_secondary_color").value = secondaryColor;
            document.getElementById("save-form").style.display = "block";
        });
        iconContainer.appendChild(col);
    });

    iconPrev.disabled = currentIconPage === 0;
    iconNext.disabled = start + iconsPerPage >= iconList.length;
}

iconPrev.addEventListener("click", () => {
    if (currentIconPage > 0) {
        currentIconPage--;
        loadIcons();
    }
});

iconNext.addEventListener("click", () => {
    if ((currentIconPage + 1) * iconsPerPage < iconList.length) {
        currentIconPage++;
        loadIcons();
    }
});

document.getElementById("icon-upload").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
            const vb = livePreview.viewBox.baseVal;
            const iconWidth = 400;
            const iconHeight = 400;
            const centerX = vb.x + vb.width / 2 - iconWidth / 2;
            const centerY = vb.y + vb.height / 2 - iconHeight / 2;

            shieldIcon.setAttribute("href", event.target.result);
            shieldIcon.setAttribute("visibility", "visible");
            shieldIcon.setAttribute("width", iconWidth);
            shieldIcon.setAttribute("height", iconHeight);
            shieldIcon.setAttribute("x", centerX);
            shieldIcon.setAttribute("y", centerY);
            updateIconContrastColor();

            document.getElementById("form_icon_filename").value = file.name;
            document.getElementById("form_primary_color").value = primaryColor;
            document.getElementById("form_secondary_color").value = secondaryColor;
            document.getElementById("save-form").style.display = "block";
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById("save-form").addEventListener("submit", function (e) {
    const svg = document.getElementById("live-preview");
    const clone = svg.cloneNode(true);

    // Clean up the viewBox string
    const vb = svg.getAttribute("viewBox");
    clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");
    clone.setAttribute("viewBox", vb);

    // Remove unnecessary transforms or visibility tags
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(clone);
    document.getElementById("final_svg").value = svgString;
});

updatePatternColors();

</script>


{% endblock %}
