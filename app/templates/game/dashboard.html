{% extends "system/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Game Title + Date -->
  <h2 class="fw-bold">Dashboard: {{ game.name }}</h2>
  <p>{{ game.date.strftime('%d.%m.%Y %H:%M') }}</p>

  <!-- Action Buttons -->
  <div class="mb-4 d-flex flex-wrap gap-2">
    <a href="{{ url_for('game_detail', game_id=game.id) }}" class="btn btn-secondary">Back to Drives</a>
    <a href="{{ url_for('game_callsheet', game_id=game.id) }}" class="btn btn-info">Offense Game Callsheet</a>
    <form id="filterForm" method="GET" action="{{ url_for('dashboard', game_id=game.id) }}" class="d-flex align-items-end ms-auto gap-2">
      <div>
        <select name="odk" id="teamFilter" class="form-select form-select-md" style="min-width: 180px;">
          <option value="" {% if not request.args.get('odk') %}selected{% endif %}>All</option>          
          <option value="O" {% if request.args.get('odk') == 'O' %}selected{% endif %}>Offense</option>
          <option value="D" {% if request.args.get('odk') == 'D' %}selected{% endif %}>Defense</option>
          <option value="K" {% if request.args.get('odk') == 'K' %}selected{% endif %}>Special</option>
        </select>
      </div>
      <div>
        <button type="submit" class="btn btn-outline-primary">Apply</button>
      </div>
    </form>
  </div>

  <div class="d-flex mb-4 gap-3" id="overviewBoxes">
    <div class="flex-fill">
      <div class="card shadow-sm text-center w-100 h-100">
        <div class="card-body">
          <h5 class="card-title">Total Drives</h5>
          <p class="display-6">{{ filtered_drives|length }}</p>
        </div>
      </div>
    </div>

    {% if not odk_filter or odk_filter == 'O' %}
      <div class="flex-fill">
        <div class="card shadow-sm text-center w-100 h-100">
          <div class="card-body">
            <h5 class="card-title">Offense Drives</h5>
            <p class="display-6">{{ offense_drives|length }}</p>
          </div>
        </div>
      </div>
    {% endif %}

    {% if not odk_filter or odk_filter == 'D' %}
      <div class="flex-fill">
        <div class="card shadow-sm text-center w-100 h-100">
          <div class="card-body">
            <h5 class="card-title">Defense Drives</h5>
            <p class="display-6">{{ defense_drives|length }}</p>
          </div>
        </div>
      </div>
    {% endif %}

    {% if not odk_filter or odk_filter == 'K' %}
      <div class="flex-fill">
        <div class="card shadow-sm text-center w-100 h-100">
          <div class="card-body">
            <h5 class="card-title">Special Teams Drives</h5>
            <p class="display-6">{{ special_drives|length }}</p>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="flex-fill">
      <div class="card shadow-sm text-center w-100 h-100">
        <div class="card-body">
          <h5 class="card-title">Total Plays</h5>
          <p class="display-6">{{ total_plays }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="card p-4 shadow-sm">
    <h4 class="mb-3">Game Analysis</h4>

    <ul class="nav nav-tabs mb-3" id="analysisTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="playtypes-tab" data-bs-toggle="tab" data-bs-target="#playtypes-content" type="button" role="tab" aria-controls="playtypes-content" aria-selected="true">
          Play Types / Result
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="penalties-tab" data-bs-toggle="tab" data-bs-target="#penalties-content" type="button" role="tab" aria-controls="penalties-content" aria-selected="false">
          Penalties
        </button>
      </li>
    </ul>

    <div class="tab-content" id="analysisTabContent">
      <div class="tab-pane fade show active" id="playtypes-content" role="tabpanel" aria-labelledby="playtypes-tab">
        {% if odk_filter == 'D' or odk_filter == 'K' %}
          <div class="text-center p-5">
              <p class="text-muted fs-5">Play Types / Result analysis is only available for the Offense view.</p>
          </div>
        {% else %}
          {% if play_type_values and play_type_values|sum > 0 %}
            <div class="row">
              <div class="col-md-6 d-flex justify-content-center align-items-center mb-3 mb-md-0">
                <div style="position: relative; height:40vh; width:80vw; max-width:400px;">
                    <canvas id="playTypeChart"></canvas>
                </div>
              </div>
              <div class="col-md-6 d-flex justify-content-center align-items-center">
                <div style="position: relative; height:40vh; width:80vw; max-width:400px;">
                    <canvas id="resultTypeChart"></canvas>
                </div>
              </div>
            </div>
          {% else %}
            <div class="text-center p-5">
              <p class="text-muted fs-5">No offensive plays found</p>
            </div>
          {% endif %}
        {% endif %}
      </div>

      <div class="tab-pane fade" id="penalties-content" role="tabpanel" aria-labelledby="penalties-tab">  
        {% if odk_filter == 'D' or odk_filter =='K' %}
          <div class="text-center p-5">
            <p class="text-muted fs-5">Penalties analysis is only available for the Offense view.</p>
          </div>
        {% else %}
          {% if penalty_values and penalty_values|sum > 0 %}
            <div class="d-flex justify-content-center">
              <div style="position: relative; height:50vh; width:90vw; max-width:450px;">
                <canvas id="penaltyChart"></canvas>
              </div>
            </div>
          {% else %}
            <p class="text-center p-5 text-muted fs-5">No penalties found.</p>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Chart Rendering -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Play Type Chart
  const ctx = document.getElementById('playTypeChart')?.getContext('2d');
  if (ctx) {
    const data = {
      labels: {{ play_type_labels | tojson }},
      datasets: [{
        data: {{ play_type_values | tojson }},
        backgroundColor: ['#28a745', '#5C1D28', '#FFD200', '#dc3545'],
        borderWidth: 1
      }]
    };
    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
    new Chart(ctx, {
      type: 'pie',
      data: data,
      plugins: [ChartDataLabels],
      options: {
        responsive: true,
        plugins: {
          datalabels: {
            color: '#fff',
            font: { weight: 'bold', size: 12 },
            formatter: value => ((value / total * 100).toFixed(1)) + '%'
          },
          legend: { 
            position: 'bottom',

         }
        }
      }
    });
  }

  // Result Type Chart
  const resultCtx = document.getElementById('resultTypeChart')?.getContext('2d');
  if (resultCtx) {
    const resultData = {
      labels: {{ result_type_labels | tojson }},
      datasets: [{
        data: {{ result_type_values | tojson }},
        backgroundColor: ['#FFD200', '#5C1D28'],
        borderWidth: 1
      }]
    };
    const resultTotal = resultData.datasets[0].data.reduce((a, b) => a + b, 0);
    new Chart(resultCtx, {
      type: 'pie',
      data: resultData,
      plugins: [ChartDataLabels],
      options: {
        plugins: {
          datalabels: {
            color: '#fff',
            font: { weight: 'bold', size: 12 },
            formatter: value => ((value / resultTotal * 100).toFixed(1)) + '%'
          },
          legend: { position: 'bottom' }
        }
      }
    });
  }
});

// Penalty Chart
const penaltyCtx = document.getElementById('penaltyChart')?.getContext('2d');
if (penaltyCtx) {
  const penaltyData = {
    labels: {{ penalty_labels | tojson }},
    datasets: [{
      label: 'Offensive Penalties',
      data: {{ penalty_values | tojson }},
      backgroundColor: [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#E7E9ED', '#83D475'
      ],
      borderWidth: 1
    }]
  };
  const penaltyTotal = penaltyData.datasets[0].data.reduce((a, b) => a + b, 0);
  new Chart(penaltyCtx, {
    type: 'pie',
    data: penaltyData,
    plugins: [ChartDataLabels],
    options: {
      responsive: true,
      plugins: {
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 12 },
          formatter: (value, ctx) => {
            const percentage = (value / penaltyTotal * 100).toFixed(1) + '%';
            return ctx.chart.width > 350 ? `${ctx.chart.data.labels[ctx.dataIndex]}\n${percentage}` : percentage;
          },
          textAlign: 'center',
        },
        legend: { 
          position: 'bottom'
        }
      }
    }
  });
}
</script>
{% endblock %}